<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Migra√ß√£o de Dados - Supabase</title>
  <style>
    body { background:#f0f0f0; margin:0; font-family: system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial; }
    .warning { background:#fff3cd; border:1px solid #ffeeba; padding:12px; border-radius:6px; margin-bottom:16px }
    .container { max-width:800px; margin:50px auto; padding:40px; background:#fff; border-radius:10px; box-shadow:0 5px 30px rgba(0,0,0,.12); }
    pre#console { background:#2c1810; color:#0f0; padding:20px; border-radius:8px; margin-top:20px; max-height:500px; overflow-y:auto; display:none; font-family: monospace }
    button#startMigration{ width:100%; padding:15px; background:#8b0000; color:#fff; border:none; border-radius:8px; font-size:18px; font-weight:700; cursor:pointer }
  </style>
</head>
<body>
  <div class="container">
    <h1 style="color:#8b0000; text-align:center; margin-bottom:20px">üóÑÔ∏è Migra√ß√£o de Dados para Supabase</h1>

    <div class="warning">
      <strong>ATEN√á√ÉO:</strong> Este processo ir√° migrar todos os dados JSON para o Supabase. Execute apenas <strong>UMA VEZ</strong>.
      <div style="margin-top:8px">Certifique-se de que as tabelas foram criadas no Supabase (execute <code>create-game-tables.sql</code>) e de que voc√™ tem conex√£o com a internet (para carregar o cliente Supabase via CDN).</div>
      <div style="margin-top:8px; color:#742a2a">Se voc√™ abrir este arquivo via <code>file://</code> e os arquivos JSON n√£o carregarem, rode um servidor HTTP local (ex.: <code>python -m http.server</code> ou <code>npx serve</code>).</div>
    </div>

    <button id="startMigration">üöÄ Iniciar Migra√ß√£o</button>
    <pre id="console"></pre>
  </div>

  <script type="module">
    // =====================================
    // SCRIPT DE MIGRA√á√ÉO DE DADOS JSON PARA SUPABASE
    // Execute este arquivo APENAS UMA VEZ para popular o banco
    // =====================================

    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.38.0/+esm';

    // Configura√ß√£o do Supabase
    const SUPABASE_URL = 'https://bifiatkpfmrrnfhvgrpb.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJpZmlhdGtwZm1ycm5maHZncnBiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA0ODM2NTMsImV4cCI6MjA3NjA1OTY1M30.g5S4aT-ml_cgGoJHWudB36EWz-3bonFZW3DEIWNOUAM';

    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // =====================================
    // CLASSE DE MIGRA√á√ÉO
    // =====================================
    class DataMigration {
        constructor() {
            this.results = {
                races: { success: 0, error: 0 },
                classes: { success: 0, error: 0 },
                backgrounds: { success: 0, error: 0 },
                feats: { success: 0, error: 0 },
                languages: { success: 0, error: 0 },
                alignments: { success: 0, error: 0 },
                equipment: { success: 0, error: 0 },
                weapons: { success: 0, error: 0 },
                armor: { success: 0, error: 0 }
            };
        }

        async loadJSON(filename) {
            try {
                // Em file:// alguns navegadores bloqueiam fetch; por isso recomendamos rodar via HTTP
                const response = await fetch(`js/data/${filename}`);
                if (!response.ok) throw new Error(`Erro ao carregar ${filename} (status: ${response.status})`);
                return await response.json();
            } catch (error) {
                console.error(`‚ùå Erro ao carregar ${filename}:`, error);
                return null;
            }
        }

        async migrateRaces() {
            console.log('üì¶ Migrando Ra√ßas...');
            const data = await this.loadJSON('races.json');
            if (!data || !data.racas) return;

            for (const race of data.racas) {
                try {
                    // Converter caracter√≠sticas para array de strings
                    const habilidadesTexto = (race.caracteristicas || []).map(c => 
                        `${c.nome}: ${c.descricao}`
                    );

                    const { error } = await supabase
                        .from('game_races')
                        .upsert({
                            id: race.id,
                            nome: race.nome,
                            fonte: race.fonte,
                            descricao: race.descricao || '',
                            tamanho: race.tamanho,
                            deslocamento: String(race.deslocamento),
                            aumentoatributos: race.aumentoAtributos,
                            habilidades: habilidadesTexto,
                            idiomas: race.idiomas || [],
                            idiomasextras: race.idiomasExtras || 0,
                            subracas: race.subracas || []
                        });

                    if (error) throw error;
                    this.results.races.success++;
                    console.log(`‚úÖ Ra√ßa "${race.nome}" migrada`);
                } catch (error) {
                    this.results.races.error++;
                    console.error(`‚ùå Erro ao migrar ra√ßa "${race.nome}":`, error?.message || error);
                }
            }
        }

        async migrateClasses() {
            console.log('üì¶ Migrando Classes...');
            const data = await this.loadJSON('classes.json');
            if (!data || !data.classes) return;

            for (const classData of data.classes) {
                try {
                    const { error } = await supabase
                        .from('game_classes')
                        .upsert({
                            id: classData.id,
                            name: classData.name,
                            source: classData.source,
                            hitdice: classData.hitDice,
                            proficiencies: classData.proficiencies,
                            equipment: classData.equipment,
                            subclasses: classData.subclasses || []
                        });

                    if (error) throw error;
                    this.results.classes.success++;
                    console.log(`‚úÖ Classe "${classData.name}" migrada`);
                } catch (error) {
                    this.results.classes.error++;
                    console.error(`‚ùå Erro ao migrar classe "${classData.name}":`, error?.message || error);
                }
            }
        }

        async migrateBackgrounds() {
            console.log('üì¶ Migrando Antecedentes...');
            const data = await this.loadJSON('backgrounds.json');
            if (!data || !data.antecedentes) return;

            for (const bg of data.antecedentes) {
                try {
                    const { error } = await supabase
                        .from('game_backgrounds')
                        .upsert({
                            id: bg.id,
                            nome: bg.nome,
                            fonte: bg.fonte,
                            descricao: bg.descricao,
                            proficiencias: bg.proficiencias,
                            equipamento: bg.equipamento,
                            caracteristica: bg.caracteristica,
                            personalidadessugeridas: bg.personalidadesSugeridas
                        });

                    if (error) throw error;
                    this.results.backgrounds.success++;
                    console.log(`‚úÖ Antecedente "${bg.nome}" migrado`);
                } catch (error) {
                    this.results.backgrounds.error++;
                    console.error(`‚ùå Erro ao migrar antecedente "${bg.nome}":`, error?.message || error);
                }
            }
        }

        async migrateFeats() {
            console.log('üì¶ Migrando Talentos...');
            const data = await this.loadJSON('feats.json');
            if (!data || !data.feats) return;

            for (const feat of data.feats) {
                try {
                    const { error } = await supabase
                        .from('game_feats')
                        .upsert({
                            id: feat.id,
                            name: feat.name,
                            source: feat.source,
                            prerequisite: feat.prerequisite,
                            description: feat.description,
                            abilityscoreincrease: feat.abilityScoreIncrease
                        });

                    if (error) throw error;
                    this.results.feats.success++;
                    console.log(`‚úÖ Talento "${feat.name}" migrado`);
                } catch (error) {
                    this.results.feats.error++;
                    console.error(`‚ùå Erro ao migrar talento "${feat.name}":`, error);
                }
            }
        }

        async migrateLanguages() {
            console.log('üì¶ Migrando Idiomas...');
            const data = await this.loadJSON('languages.json');
            if (!data || !data.languages) return;

            try {
                const { error } = await supabase
                    .from('game_languages')
                    .upsert({
                        id: 'dnd-5e-languages',
                        languages: data.languages.standard || [],
                        scripts: data.scripts || [],
                        notes: data.notes || ''
                    });

                if (error) throw error;
                this.results.languages.success++;
                console.log(`‚úÖ Idiomas migrados`);
            } catch (error) {
                this.results.languages.error++;
                console.error(`‚ùå Erro ao migrar idiomas:`, error);
            }
        }

        async migrateAlignments() {
            console.log('üì¶ Migrando Tend√™ncias...');
            const data = await this.loadJSON('alignments.json');
            if (!data || !data.alinhamentos) return;

            for (const alignment of data.alinhamentos) {
                try {
                    const { error } = await supabase
                        .from('game_alignments')
                        .upsert({
                            id: alignment.id,
                            nome: alignment.nome,
                            abreviacao: alignment.abreviacao,
                            descricao: alignment.descricao,
                            caracteristicas: alignment.caracteristicas
                        });

                    if (error) throw error;
                    this.results.alignments.success++;
                    console.log(`‚úÖ Tend√™ncia "${alignment.nome}" migrada`);
                } catch (error) {
                    this.results.alignments.error++;
                    console.error(`‚ùå Erro ao migrar tend√™ncia "${alignment.nome}":`, error);
                }
            }
        }

        async migrateEquipment() {
            console.log('üì¶ Migrando Equipamentos...');
            const data = await this.loadJSON('equipment.json');
            if (!data || !data.equipamentos) return;

            // Equipment tem estrutura aninhada: pacotes, ferramentas, etc.
            const allEquipment = [
                ...(data.equipamentos.pacotes || []),
                ...(data.equipamentos.ferramentas || []),
                ...(data.equipamentos.kits || []),
                ...(data.equipamentos.montarias || []),
                ...(data.equipamentos.veiculos || []),
                ...(data.equipamentos.outros || [])
            ];

            for (const item of allEquipment) {
                try {
                    const { error } = await supabase
                        .from('game_equipment')
                        .upsert({
                            id: item.id,
                            nome: item.nome,
                            tipo: item.tipo || 'Geral',
                            custo: JSON.stringify(item.custo),
                            peso: String(item.peso || '0'),
                            descricao: item.descricao || '',
                            propriedades: item.propriedades || item.conteudo || []
                        });

                    if (error) throw error;
                    this.results.equipment.success++;
                    console.log(`‚úÖ Equipamento "${item.nome}" migrado`);
                } catch (error) {
                    this.results.equipment.error++;
                    console.error(`‚ùå Erro ao migrar equipamento "${item.nome}":`, error);
                }
            }
        }

        async migrateWeapons() {
            console.log('üì¶ Migrando Armas...');
            const data = await this.loadJSON('weapons.json');
            if (!data || !data.armas) return;

            for (const weapon of data.armas) {
                try {
                    const { error } = await supabase
                        .from('game_weapons')
                        .upsert({
                            id: weapon.id,
                            nome: weapon.nome,
                            categoria: weapon.categoria,
                            custo: JSON.stringify(weapon.custo),
                            dano: weapon.dano || '‚Äî',
                            peso: String(weapon.peso || '0'),
                            propriedades: weapon.propriedades || []
                        });

                    if (error) throw error;
                    this.results.weapons.success++;
                    console.log(`‚úÖ Arma "${weapon.nome}" migrada`);
                } catch (error) {
                    this.results.weapons.error++;
                    console.error(`‚ùå Erro ao migrar arma "${weapon.nome}":`, error);
                }
            }
        }

        async migrateArmor() {
            console.log('üì¶ Migrando Armaduras...');
            const data = await this.loadJSON('armor.json');
            if (!data || !data.armaduras) return;

            for (const armor of data.armaduras) {
                try {
                    const { error } = await supabase
                        .from('game_armor')
                        .upsert({
                            id: armor.id,
                            nome: armor.nome,
                            categoria: armor.categoria,
                            custo: JSON.stringify(armor.custo),
                            ca: armor.ca || String(armor.caBase || '10'),
                            peso: String(armor.peso || '0'),
                            furtividade: armor.desvantagemFurtividade ? 'Desvantagem' : 'Normal'
                        });

                    if (error) throw error;
                    this.results.armor.success++;
                    console.log(`‚úÖ Armadura "${armor.nome}" migrada`);
                } catch (error) {
                    this.results.armor.error++;
                    console.error(`‚ùå Erro ao migrar armadura "${armor.nome}":`, error?.message || error);
                }
            }
        }

        async runMigration() {
            console.log('üöÄ Iniciando migra√ß√£o de dados para Supabase...\n');
            
            const startTime = Date.now();

            // Executar todas as migra√ß√µes
            await this.migrateRaces();
            await this.migrateClasses();
            await this.migrateBackgrounds();
            await this.migrateFeats();
            await this.migrateLanguages();
            await this.migrateAlignments();
            await this.migrateEquipment();
            await this.migrateWeapons();
            await this.migrateArmor();

            const endTime = Date.now();
            const duration = ((endTime - startTime) / 1000).toFixed(2);

            // Exibir relat√≥rio
            console.log('\n' + '='.repeat(50));
            console.log('üìä RELAT√ìRIO DE MIGRA√á√ÉO');
            console.log('='.repeat(50));
            
            let totalSuccess = 0;
            let totalErrors = 0;

            Object.entries(this.results).forEach(([key, stats]) => {
                totalSuccess += stats.success;
                totalErrors += stats.error;
                console.log(`${key.padEnd(15)} ‚úÖ ${stats.success} | ‚ùå ${stats.error}`);
            });

            console.log('='.repeat(50));
            console.log(`TOTAL:          ‚úÖ ${totalSuccess} | ‚ùå ${totalErrors}`);
            console.log(`Tempo:          ${duration}s`);
            console.log('='.repeat(50));

            if (totalErrors === 0) {
                console.log('\n‚úÖ Migra√ß√£o conclu√≠da com sucesso!');
                console.log('üìå Agora voc√™ pode usar os dados do Supabase no sistema.');
            } else {
                console.log('\n‚ö†Ô∏è Migra√ß√£o conclu√≠da com alguns erros.');
                console.log('üìå Verifique os logs acima para mais detalhes.');
            }
        }
    }

    // =====================================
    // EXECU√á√ÉO
    // =====================================

    document.addEventListener('DOMContentLoaded', () => {
        const consoleDiv = document.getElementById('console');
        const originalLog = console.log;
        const originalError = console.error;

        console.log = function(...args) {
            originalLog.apply(console, args);
            consoleDiv.style.display = 'block';
            consoleDiv.textContent += args.join(' ') + '\n';
            consoleDiv.scrollTop = consoleDiv.scrollHeight;
        };

        console.error = function(...args) {
            originalError.apply(console, args);
            consoleDiv.style.display = 'block';
            consoleDiv.textContent += '‚ùå ' + args.join(' ') + '\n';
            consoleDiv.scrollTop = consoleDiv.scrollHeight;
        };

        // Bot√£o de iniciar
        document.getElementById('startMigration').addEventListener('click', async () => {
            const btn = document.getElementById('startMigration');
            btn.disabled = true;
            btn.textContent = '‚è≥ Migrando...';
            consoleDiv.textContent = '';

            const migration = new DataMigration();
            await migration.runMigration();

            btn.textContent = '‚úÖ Migra√ß√£o Conclu√≠da';
            btn.style.background = '#2d7d2d';
        });

        // Mostra aviso se estiver rodando via file://
        if (location.protocol === 'file:') {
            console.warn('Voc√™ abriu o arquivo via file:// ‚Äî alguns navegadores bloqueiam fetch. Se ocorrerem erros ao carregar os JSON, execute um servidor HTTP local (ex.: python -m http.server) e abra via http://localhost:8000');
        }
    });
  </script>
</body>
</html>